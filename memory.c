#include <stdio.h>

#include "error.h"
#include "memory.h"

#define N_LOGO_OFFSET 0x104

static int cmp_nintendo_logo(void)
{
	int i;
	int ret = 0;

	unsigned char nintendo_logo[48] =
	{
		0xCE, 0xED, 0x66, 0x66, 0xCC, 0x0D, 0x00, 0x0B,
		0x03, 0x73, 0x00, 0x83, 0x00, 0x0C, 0x00, 0x0D,
		0x00, 0x08, 0x11, 0x1F, 0x88, 0x89, 0x00, 0x0E,
		0xDC, 0xCC, 0x6E, 0xE6, 0xDD, 0xDD, 0xD9, 0x99,
		0xBB, 0xBB, 0x67, 0x63, 0x6E, 0x0E, 0xEC, 0xCC,
		0xDD, 0xDC, 0x99, 0x9F, 0xBB, 0xB9, 0x33, 0x3E
	};

	for (i = 0; i < 48; ++i) {
		if (memory[i + N_LOGO_OFFSET] != nintendo_logo[i]) {
			ret = 1;
			break;
		}
	}

	return ret;
}

static int check_complement(void)
{
	int i;
	int sum = 0;

	for (i = 0x134; i < 0x14E; ++i) {
		sum += memory[i];
	}

	sum += 25;

	if ((sum & 0xFF) != 0) {
		return 1;
	}

	return 0;
}

static void choose_mbc(void)
{
	int mode;

	mode = memory[0x147];

	switch(mode) {
	case 0x00:
		break;
	}
}

void read_rom(void)
{
#ifdef DEBUG
	int i;

	for (i = 0x104; i < 0x134; ++i) {
		printf("%.2X\n", memory[i]);
	}
#endif
}

int init_memory(void)
{
	int ret = 0;

	if (cmp_nintendo_logo() != 0) {
		ret = VALIDATION_ERR;
		goto out;
	}

	if (check_complement() != 0) {
		ret = VALIDATION_ERR;
		goto out;
	}

	memory[0xFF05] = 0x00;
	memory[0xFF06] = 0x00;
	memory[0xFF07] = 0x00;
	memory[0xFF10] = 0x80;
	memory[0xFF11] = 0xBF;
	memory[0xFF12] = 0xF3;
	memory[0xFF14] = 0xBF;
	memory[0xFF16] = 0x3F;
	memory[0xFF17] = 0x00;
	memory[0xFF19] = 0xBF;
	memory[0xFF1A] = 0x7F;
	memory[0xFF1B] = 0xFF;
	memory[0xFF1C] = 0x9F;
	memory[0xFF1E] = 0xBF;
	memory[0xFF20] = 0xFF;
	memory[0xFF21] = 0x00;
	memory[0xFF22] = 0x00;
	memory[0xFF23] = 0xBF;
	memory[0xFF24] = 0x77;
	memory[0xFF25] = 0xF3;
	memory[0xFF26] = 0xF1;
	memory[0xFF40] = 0x91;
	memory[0xFF42] = 0x00;
	memory[0xFF43] = 0x00;
	memory[0xFF45] = 0x00;
	memory[0xFF47] = 0xFC;
	memory[0xFF48] = 0xFF;
	memory[0xFF49] = 0xFF;
	memory[0xFF4A] = 0x00;
	memory[0xFF4B] = 0x00;
	memory[0xFFFF] = 0x00;

out:
	return ret;
}
